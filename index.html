<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0,viewport-fit=cover"/>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    
    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:ital,wght@0,100;0,400;0,600;1,100;1,400;1,600&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/custom.css">

    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <title>INSTi</title>
  </head>
  <body class="vh-100">
   <div id="cart" class="container vh-100 position-relative d-none">
     <div class="row py-3">
       <div class="col-4 d-flex flex-wrap align-items-center">
         <img src="assets/logo.png" class="img-fluid" alt="INSTi Logo">
       </div>
       <div class="col-8">
         <p class="font-weight-bold mb-0">ชุดตรวจเอชไอวีด้วยตัวเอง</p>
         <p class="text-muted small mb-0">อินสติ INSTI เป็นชุดตรวจคัดกรองเอชไอวีด้วยตนเองที่ใช้เวลาตรวจเพียง 1 นาทีเท่านั้น</p>
       </div>
     </div>

     <div class="row">
       <div class="col-12 px-0">
          <img src="assets/banner.png" class="img-fluid rounded" alt="INSTi Logo">
       </div>
     </div>

     <div class="row">
      <div class="col-12 py-3">
        <p class="font-weight-bold text-muted mb-0">รายการสินค้าที่สนใจ</p>
         <table class="table">
           <thead></thead>
           <tbody>
             <tr>
               <td width="50%">ชุดตรวจเอชไอวี Insti</td>
               <td class="id-input">
                <div class="value-button decrease" value="Decrease Value">-</div>
                <input id="product-1" type="number" class="number" value="0" />
                <div class="value-button increase" value="Increase Value">+</div>
               </td>
             </tr>
             <tr>
               <td width="50%">ชุดตรวจหนองใน ด้วยตัวเอง</td>
               <td class="id-input">
                <div class="value-button decrease" value="Decrease Value">-</div>
                <input id="product-2" type="number" class="number" value="0" />
                <div class="value-button increase" value="Increase Value">+</div>
               </td>
             </tr>
           </tbody>
         </table>
      </div>
    </div>

    <div class="position-absolute bottom-0 start-50 translate-middle-x w-100 px-0">
      <button id="checkout-cart" class="btn btn-success btn-mobile">สั่งซื้อเลย</button>
    </div>
   </div>

   <div id="deliver" class="container vh-100 position-relative d-none">
    <div class="row">
      <div class="col-12 py-3">
        <p class="font-weight-bold text-muted mb-2">รายการสินค้าที่สนใจ</p>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio1" value="option1" checked>
          <label class="form-check-label" for="inlineRadio1">จัดส่งทาง Kerry, Flash, J&T</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio2" value="option2">
          <label class="form-check-label" for="inlineRadio2">ส่งส่งผ่าน Grab</label>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-12 py-3">
        <p class="font-weight-bold text-muted mb-2">กรุณาระบุหมายเลขโทรศัพท์ของท่าน</p>
        <input type="tel" name="tel" class="form-control">
      </div>
    </div>

    <div class="row">
      <div class="col-12 py-3">
        <p class="font-weight-bold text-muted mb-2">กรุณาระบุชื่อผู้รับสินค้า</p>
        <input type="text" class="form-control" name="customer_name">
      </div>
    </div>

    <div id="map-container" class="row d-none">
      <div class="col-12 py-3">
        <p class="font-weight-bold text-muted mb-2">กรุณาระบุสถานที่จัดส่งสินค้า</p>
        <div id="map" style="width: 100%;height: 450px;"></div>
      </div>
    </div>

    <div class="row">
      <div class="col-12 py-3">
        <p class="font-weight-bold text-muted mb-2">กรุณาระบุที่อยู่/เลขที่บ้านสำหรับจัดส่งสินค้า</p>
        <input type="text" class="form-control" name="address">
      </div>
    </div>

    <div class="row">
      <div class="col-3 py-3">
        <p class="font-weight-bold text-muted mb-2">ราคา</p>
      </div>
      <div class="col-9 py-3">
        <p class="text-center"><span id="total-price">0</span> บาท</p>
      </div>
    </div>

    <div class="position-absolute bottom-0 start-50 translate-middle-x w-100 px-0">
      <button id="checkout-deliver" class="btn btn-success btn-mobile">สั่งซื้อเลย</button>
    </div>
   </div>

    <!-- Bootstrap script -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    
    <!-- Line LIFF -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
      $(function () {
        $('.increase').click(function() {
          let scope = $(this).parent(".id-input");
          let input_field = scope.find(".number");

          var value = parseInt(input_field.val(), 10);
          value = isNaN(value) ? 0 : value;
          value++;
          input_field.val(value);
        }); 
        
        $('.decrease').click(function() {
          let scope = $(this).parent(".id-input");
          let input_field = scope.find(".number");

          var value = parseInt(input_field.val(), 10);
          value = isNaN(value) ? 0 : value;
          value < 1 ? value = 1 : '';
          value--;
          input_field.val(value);
        }); 

        $('#checkout-cart').click(function() {
          $('#cart').addClass("d-none");

          let product_1 = $('#product-1').val();
          let product_2 = $('#product-2').val();

          var sum_product = parseInt(product_1) + parseInt(product_2);
          var total_price = sum_product * 700;

          $('#total-price').text(total_price.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));

          $('#deliver').removeClass("d-none");
        });

        $('input[name="inlineRadioOptions"]').change(function() {
          var radio_option = $(this).prop('checked', true).val();

          if (radio_option != 'option1') {
            $('#map-container').removeClass('d-none');
          } else {
            $('#map-container').addClass('d-none');
          }
        });

        $('#checkout-deliver').click(function() {
          $('#deliver').addClass("d-none");

          sendMsg()

          liff.closeWindow();
        });
      }); 

      async function main() {
        liff.ready.then(() => {
          if (liff.isLoggedIn()) {
            $('#cart').removeClass("d-none");
          } else {
            liff.login();
          }
        });
        await liff.init({ liffId: "1656517638-x8aYEG1D" });
      }
      
      async function sendMsg() {
        if (liff.getContext().type !== "none") {
          var customer_name = $('input[name="customer_name"]').val();
          var tel           = $('input[name="tel"]').val();
          var address       = $('input[name="address"]').val();
          var option        = $('input[name="inlineRadioOptions"]').prop('checked', true).val();
          var option_text   = '';
          let product_1 = $('#product-1').val();
          let product_2 = $('#product-2').val();

          if('inlineRadioOptions' == 'option1') {
            option_text = 'จัดส่งทาง Kerry, Flash, J&T ';
          } else {
            option_text = 'ส่งส่งผ่าน Grab';
          }

          let text_message = {
            "type": "bubble",
            "body": {
              "type": "box",
              "layout": "vertical",
              "contents": [
                {
                  "type": "text",
                  "text": "รายการคำสั่งซื้อ",
                  "weight": "bold",
                  "size": "xl"
                },
                {
                  "type": "box",
                  "layout": "vertical",
                  "margin": "lg",
                  "spacing": "sm",
                  "contents": [
                    {
                      "type": "box",
                      "layout": "baseline",
                      "spacing": "sm",
                      "contents": [
                        {
                          "type": "text",
                          "text": "รายการวันนี้เป็นแบบ" + option_text,
                          "wrap": true,
                          "color": "#666666",
                          "size": "sm",
                          "flex": 6
                        }
                      ]
                    },
                    {
                      "type": "box",
                      "layout": "baseline",
                      "spacing": "sm",
                      "contents": [
                        {
                          "type": "text",
                          "text": "เบอร์โทรศัพท์ของคุณลูกค้า คือ " + tel,
                          "wrap": true,
                          "color": "#666666",
                          "size": "sm",
                          "flex": 6
                        }
                      ]
                    },
                    {
                      "type": "box",
                      "layout": "baseline",
                      "spacing": "sm",
                      "contents": [
                        {
                          "type": "text",
                          "text": "ที่อยู่ในการจัดส่ง คือ " + address,
                          "wrap": true,
                          "color": "#666666",
                          "size": "sm",
                          "flex": 6
                        }
                      ]
                    },
                    {
                      "type": "box",
                      "layout": "baseline",
                      "spacing": "sm",
                      "contents": [
                        {
                          "type": "text",
                          "text": "รายการของคุณ" + customer_name + " คือ",
                          "wrap": true,
                          "color": "#666666",
                          "size": "sm",
                          "flex": 6
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            "styles": {
              "header": {
                "separator": false
              }
            }
          }

          if (product_1 != 0) {
            text_message.body.contents.push({
              "type": "box",
              "layout": "baseline",
              "spacing": "md",
              "margin": "sm",
              "contents": [
                {
                  "type": "text",
                  "text": " - ชุดตรวจเอชไอวี Insti (700 บาท) จำนวน " + product_1,
                  "wrap": true,
                  "color": "#666666",
                  "size": "sm",
                  "flex": 6
                }
              ]
            })
          }

          if (product_2 != 0) {
            text_message.body.contents.push({
              "type": "box",
              "layout": "baseline",
              "spacing": "md",
              "margin": "sm",
              "contents": [
                {
                  "type": "text",
                  "text": " - ชุดตรวจหนองใน ด้วยตัวเอง (700 บาท) จำนวน " + product_2,
                  "wrap": true,
                  "color": "#666666",
                  "size": "sm",
                  "flex": 6
                }
              ]
            })
          }

          text_message.body.contents.push({
              "type": "box",
              "layout": "baseline",
              "spacing": "sm",
              "contents": [
                {
                  "type": "text",
                  "text": "เมื่อคุณลูกค้าชำระเงินเรียบร้อยแล้ว กรุณาส่งหลักฐานการชำระเงินผ่านทาง Line: Insti",
                  "wrap": true,
                  "color": "#666666",
                  "size": "sm",
                  "flex": 6
                }
              ]
            })

          await liff.sendMessages([
            {
              type: "flex",
              altText: 'รายการการสั่งซื้อ',
              contents: text_message
            },
          ]);
        }
      }

      main();
    </script>

    <script>      
      function initMap() {
        var mapOptions = {
          center: {lat: 18.82109114031255, lng: 98.98485360000001},
          zoom: 8,
        }
          
        var maps = new google.maps.Map(document.getElementById("map"),mapOptions);

        infoWindow = new google.maps.InfoWindow;

        // Try HTML5 geolocation.
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
          var pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };

          infoWindow.setPosition(pos);
          infoWindow.setContent('Location found. lat: ' + position.coords.latitude + ', lng: ' + position.coords.longitude + ' ');
          infoWindow.open(maps);
          map.setCenter(pos);
          }, function() {
          handleLocationError(true, infoWindow, map.getCenter());
          });
        } else {
          // Browser doesn't support Geolocation
          handleLocationError(false, infoWindow, map.getCenter());
        }
      }
      function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
                              'Error: The Geolocation service failed.' :
                              'Error: Your browser doesn\'t support geolocation.');
        infoWindow.open(map);
      }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDT6p7WiAwz_Qyjflo6Rnrfb6qOYYC8bY8&;callback=initMap" async defer></script>
  </body>
</html>